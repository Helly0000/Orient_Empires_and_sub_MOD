############# TributeSystem_effects
# by 往来天地间 WangLaiTianDiJian
# TributeSystem
#WLTDJ20220116

#UPDATE 20230827


#通用架构
make_tributary = {
	$TYPE$ = {
		TRIBUTARY = $TRIBUTARY$
		SUZERAIN = $SUZERAIN$
	}
}
######################################
#Base Types
tributary_non_permanent = {
	define_tributary = {
		TRIBUTARY = $TRIBUTARY$
		SUZERAIN = $SUZERAIN$
		TRIBUTARY_BASE_TYPE = flag:non_permanent
	}
}

tributary_permanent = {
	define_tributary = {
		TRIBUTARY = $TRIBUTARY$
		SUZERAIN = $SUZERAIN$
		TRIBUTARY_BASE_TYPE = flag:permanent
	}
}
######################################
define_tributary = {
	$TRIBUTARY$ = { 
		set_relation_suzerain = $SUZERAIN$

		set_variable = { name = my_suzerain value = $SUZERAIN$ }
		set_variable = { name = tributary_type value = $TRIBUTARY_BASE_TYPE$ } #临时永久
		add_trait = tributary
		change_tribute_exp_effect = { EXP = 10 } #朝贡得分
		primary_title = { set_color_from_title = $SUZERAIN$.primary_title }
	}

	$SUZERAIN$ = {
		if = {
			limit = {
				NOT = { has_trait = suzerain }
			}
			add_trait = suzerain
		}

		switch = {
			trigger = $TRIBUTARY_BASE_TYPE$

			flag:permanent = {
				add_to_variable_list = {
					name = permanent_tributaries
					target = $TRIBUTARY$
				}
			}
			flag:non_permanent = {
				add_to_variable_list = {
					name = non_permanent_tributaries
					target = $TRIBUTARY$
				}
			}
		}

		#set_variable = { name = suzerain_exp value = 10 } #宗主得分
		add_to_variable_list = {
			name = all_tributaries
			target = $TRIBUTARY$
		}
	}
}

#停止朝贡
unset_tributary = {
	$TRIBUTARY$ = {
		if = {
			limit = {
				exists = var:my_suzerain
			}
			var:my_suzerain = {
				if = {
					limit = {
						is_target_in_variable_list = { name = non_permanent_tributaries target = prev }
					}
					remove_list_variable = { name = non_permanent_tributaries target = prev }
				}
				if = {
					limit = {
						is_target_in_variable_list = { name = permanent_tributaries target = prev }
					}
					remove_list_variable = { name = permanent_tributaries target = prev }
				}
				remove_list_variable = { name = all_tributaries target = prev }
				#remove_relation_tributary = $TRIBUTARY$
				if = {
					limit = {
						NOT = { has_tributaries = yes }
						has_trait = suzerain
					}
					remove_trait = suzerain
				}
			}
		}
		remove_relation_suzerain = var:my_suzerain
		remove_trait = tributary
		if = {
			limit = { has_variable = my_suzerain }
			remove_variable = my_suzerain
		}
		if = {
			limit = { has_variable = tributary_type }
			remove_variable = tributary_type
		}
		if = {
			limit = { has_variable = my_suzerain }
			remove_variable = my_suzerain
		}
		if = {
			limit = { has_variable = tributary_exp_gain }
			remove_variable = tributary_exp_gain
		}
		
		if = {
			limit = {
				exists = primary_title
				exists = capital_county
				primary_title = { is_titular = no }
			}
			primary_title = { set_color_from_title = $TRIBUTARY$.capital_county }
		}		
	}
}

#继承朝贡
pass_tributary_type_to_heir = {
	$SCOPE$ = {
		switch = {
			trigger = $TYPE$

			flag:permanent = {
				make_tributary = {
					TYPE = tributary_permanent
					TRIBUTARY = $TRIBUTARY$
					SUZERAIN = $NEW_RULER$
				}	
			}
		}
	}
}


#入贡
offer_tribute_effect = {
	if = {
		limit = {
			scope:permanent_trib = yes
		}
		make_tributary = {
			TYPE = tributary_non_permanent
			TRIBUTARY = scope:actor
			SUZERAIN = scope:recipient
		}				
	}	
	if = {
		limit = {
			scope:non_permanent_trib = yes
		}	
		make_tributary = {
			TYPE = tributary_permanent
			TRIBUTARY = scope:actor
			SUZERAIN = scope:recipient
		}					
	}
}

#要求入贡
demand_tribute_effect = {
	if = {
		limit = {
			scope:non_permanent_trib = yes
		}
		make_tributary = {
			TYPE = tributary_non_permanent
			SUZERAIN = scope:actor
			TRIBUTARY = scope:recipient
		}
	}
	else_if = {
		limit = {
			scope:permanent_trib = yes
		}
		make_tributary = {
			TYPE = tributary_permanent
			SUZERAIN = scope:actor
			TRIBUTARY = scope:recipient
		}		
	}
}


#夺取朝贡国
replace_suzerain_effect = {
	$TRIBUTARY$ = {
		every_relation = {
			type = suzerain
			$TRIBUTARY$ = { remove_relation_suzerain = this }
			add_opinion = {
				modifier = seize_tributary_opinion
				target = $SUZERAIN$
			}
		}

		#remove_variable = tributary_exp
		remove_variable = my_suzerain

		make_tributary = { SUZERAIN = $SUZERAIN$ TRIBUTARY = $TRIBUTARY$ TYPE = var:tributary_type }
		add_opinion = {
			modifier = forced_tributary_opinion
			target = $SUZERAIN$
		}
	}
}

#进贡
pay_tribute_effect = {
	#朝贡国
	scope:actor = {
		add_character_flag =  {
			flag = payed_tribute
			years = 3
		}
		reverse_add_opinion = {
			target = scope:recipient
			modifier = humbled_opinion
			opinion = var:tributary_exp_gain
		}
		trigger_event = TributeSystem.1016  #选类型
	}
	#宗主国
	scope:recipient = {
		trigger_event = TributeSystem.1017 #选择赏赐规模，选择加点类型
	}
}

TributeSystem_tribute_relation_validity_check_effect = {
	if = {
		limit = {
			OR = {
				$SUZERAIN$.highest_held_title_tier <= $TRIBUTARY$.highest_held_title_tier
				$SUZERAIN$ = { can_be_suzerain_trigger = no }
				$TRIBUTARY$ = { can_be_tributary_trigger = no }
			}
		}
		unset_tributary = { TRIBUTARY = $TRIBUTARY$ }
		$SUZERAIN$ = { TributeSystem_suzerain_validity_check_effect = yes }
		#$SUZERAIN$ = {
			#if = {
                #limit = {
                    #is_target_in_variable_list = { name = non_permanent_tributaries target = $TRIBUTARY$ }
                #}
                #remove_list_variable = { name = non_permanent_tributaries target = $TRIBUTARY$ }
            #}
            #if = {
                #limit = {
                    #is_target_in_variable_list = { name = permanent_tributaries target = $TRIBUTARY$ }
                #}
                #remove_list_variable = { name = permanent_tributaries target = $TRIBUTARY$ }
            #}
            #remove_list_variable = { name = all_tributaries target = $TRIBUTARY$ }
			#remove_trait = suzerain
			#send_interface_message = {
				#type = event_toast_text_and_effect_bad
				#left_icon = $SUZERAIN$
				#right_icon = $TRIBUTARY$
				#title = TributeSystem_relation_validity_check_01_desc.tt
				#desc = TributeSystem_relation_validity_check_01_desc
			#}
		#}
		#$TRIBUTARY$ = {
			#remove_relation_suzerain = $SUZERAIN$
			#remove_variable = tributary_type
			#remove_variable = my_suzerain
			#remove_trait = tributary
			#send_interface_message = {
				#type = event_toast_text_and_effect_bad
				#left_icon = $SUZERAIN$
				#right_icon = $TRIBUTARY$
				#title = TributeSystem_relation_validity_check_02_desc.tt
				#desc = TributeSystem_relation_validity_check_02_desc
			#}
		#}
	}
}


TributeSystem_suzerain_validity_check_effect = {
	if = {
		limit = {
			has_trait = suzerain
			has_tributaries = no
		}
		remove_trait = suzerain
	}
}
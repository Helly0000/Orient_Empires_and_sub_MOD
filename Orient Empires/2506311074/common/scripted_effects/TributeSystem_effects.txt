############# TributeSystem_effects
# by 往来天地间 WangLaiTianDiJian
# TributeSystem
#WLTDJ20220116

#UPDATE 20230827

#tributary_non_permanent
#tributary_permanent
#TYPE = flag:china_tributary
#flag:karling_tributary

#通用架构
make_tributary = {
	if = {
		limit = {
			$TRIBUTARY$ = { is_independent_ruler = yes }
		}
		$TYPE$ = {
			TRIBUTARY = $TRIBUTARY$
			SUZERAIN = $SUZERAIN$
		}
	}
}
define_tributary = {
	$TRIBUTARY$ = { 
		set_relation_suzerain = $SUZERAIN$

		set_variable = { name = my_suzerain value = $SUZERAIN$ }
		set_variable = { name = tributary_type value = $TRIBUTARY_BASE_TYPE$ } #临时永久
		#set_variable = { name = tributary_exp value = 10 } #朝贡得分
		add_trait = tributary
	}

	$SUZERAIN$ = {
		if = {
			limit = {
				NOT = { has_trait = suzerain }
			}
			add_trait = suzerain
		}

		switch = {
			trigger = $TRIBUTARY_BASE_TYPE$

			flag:permanent = {
				add_to_variable_list = {
					name = permanent_tributaries
					target = $TRIBUTARY$
				}
			}
			flag:non_permanent = {
				add_to_variable_list = {
					name = non_permanent_tributaries
					target = $TRIBUTARY$
				}
			}
		}

		#set_variable = { name = suzerain_exp value = 10 } #宗主得分
		add_to_variable_list = {
			name = all_tributaries
			target = $TRIBUTARY$
		}
	}
}

#停止朝贡
unset_tributary = {
	$TRIBUTARY$ = {
		var:my_suzerain = {
						
			if = {
				limit = {
					is_target_in_variable_list = { name = non_permanent_tributaries target = prev }
				}
				remove_list_variable = { name = non_permanent_tributaries target = prev }
			}
			if = {
				limit = {
					is_target_in_variable_list = { name = permanent_tributaries target = prev }
				}
				remove_list_variable = { name = permanent_tributaries target = prev }
			}
			remove_list_variable = { name = all_tributaries target = prev }

		}
		scope:suzerain = {
			if = {
				limit = {
					has_tributaries = no
					has_trait = suzerain
				}
				remove_trait = suzerain
			}
		}
		remove_relation_suzerain = var:my_suzerain

		remove_trait = tributary	
		remove_variable = my_suzerain
		remove_variable = tributary_type
		#remove_variable = tributary_exp
	}
}

#继承朝贡
pass_tributary_type_to_heir = {
	$SCOPE$ = {
		switch = {
			trigger = $TYPE$

			flag:permanent = {
				make_tributary = {
					TYPE = tributary_permanent
					TRIBUTARY = $TRIBUTARY$
					SUZERAIN = $NEW_RULER$
				}	
			}
		}
	}
}

#夺取朝贡国
replace_suzerain_effect = {
	$TRIBUTARY$ = {
		every_relation = {
			type = suzerain
			$TRIBUTARY$ = { remove_relation_suzerain = this }
			add_opinion = {
				modifier = seize_tributary_opinion
				target = $SUZERAIN$
			}
		}

		#remove_variable = tributary_exp
		remove_variable = my_suzerain

		make_tributary = { SUZERAIN = $SUZERAIN$ TRIBUTARY = $TRIBUTARY$ TYPE = var:tributary_type }
		add_opinion = {
			modifier = forced_tributary_opinion
			target = $SUZERAIN$
		}
	}
}

################

tributary_opinion_effect = {
	$SUZERAIN$ = {
		add_trait = suzerain
	}
	$TRIBUTARY$ = {
		add_trait = tributary
	}
	$TRIBUTARY$ = {
		var:my_suzerain = {
			add_opinion = {
				modifier = stop_tributary_opinion
				target = $TRIBUTARY$
			}
		}
		add_opinion = {
			modifier = stop_tributary_opinion
			target = var:my_suzerain
		}
	}
}


tributary_track_effect = {
	if = {
		limit = { $TRIBUTARY$ = { TributeSystem_is_civilized_tributary_of_trigger = yes } }
		$SUZERAIN$ = {
			add_trait = suzerain
			add_trait_xp = {
				trait = tributary
				track = civilized_suzerain
				value = var:suzerain_exp
			}
			add_opinion = {
				modifier = tributary_opinion
				target = $TRIBUTARY$
			}
		}
		$TRIBUTARY$ = {
			add_trait = tributary
			add_trait_xp = {
				trait = tributary
				track = civilized
				#value = var:tributary_exp
			}
			add_opinion = {
				modifier = suzerain_opinion
				target = $SUZERAIN$
			}
		}
	}
	else_if = {
		limit = { $TRIBUTARY$ = { TributeSystem_is_league_tributary_of_trigger = yes } }
		$SUZERAIN$ = {
			add_trait = suzerain
			add_trait_xp = {
				trait = tributary
				track = league_suzerain
				value = var:suzerain_exp
			}
			add_opinion = {
				modifier = tributary_opinion
				target = $TRIBUTARY$
			}
		}
		$TRIBUTARY$ = {
			add_trait = tributary
			add_trait_xp = {
				trait = tributary
				track = league
				#value = var:tributary_exp
			}
			add_opinion = {
				modifier = suzerain_opinion
				target = $SUZERAIN$
			}
		}
	}
	else_if = {
		limit = { $TRIBUTARY$ = { TributeSystem_is_hegemony_tributary_of_trigger = yes } }
		$SUZERAIN$ = {
			add_trait = suzerain
			add_trait_xp = {
				trait = tributary
				track = hegemony_suzerain
				value = var:suzerain_exp
			}
			add_opinion = {
				modifier = tributary_opinion
				target = $TRIBUTARY$
			}
		}
		$TRIBUTARY$ = {
			add_trait = tributary
			add_trait_xp = {
				trait = tributary
				track = hegemony
				#value = var:tributary_exp
			}
			add_opinion = {
				modifier = suzerain_opinion
				target = $SUZERAIN$
			}
		}
	}
}

#入贡
offer_tribute_effect = {
	scope:recipient = {
		if = {
			limit = {
				scope:permanent_trib = yes
			}
			make_tributary = {
				TYPE = tributary_non_permanent
				TRIBUTARY = scope:recipient
				SUZERAIN = scope:actor
			}				
		}	
		if = {
			limit = {
				scope:non_permanent_trib = yes
			}	
			make_tributary = {
				TYPE = tributary_permanent
				TRIBUTARY = scope:recipient
				SUZERAIN = scope:actor
			}					
		}
	}
}
#进贡
pay_tribute_effect = {
	$TRIBUTARY$ = { 
		#change_variable = {	name = tributary_exp add = 10 } #改为特质经验
	}
}
#赏赐
bestow_reward_effect = {
	$TRIBUTARY$ = { 
		#change_variable = {	name = tributary_exp add = 10 } #改为特质经验
	}
}

#索贡
demand_tribute_effect = {
	scope:actor = {
		if = {
			limit = {
				scope:permanent_trib = yes
			}
			make_tributary = {
				TYPE = tributary_non_permanent
				TRIBUTARY = scope:recipient
				SUZERAIN = scope:actor
			}				
		}	
		if = {
			limit = {
				scope:non_permanent_trib = yes
			}	
			make_tributary = {
				TYPE = tributary_permanent
				TRIBUTARY = scope:recipient
				SUZERAIN = scope:actor
			}					
		}
	}
}

#赏赐岁币？
TributeSystem_pay_income_function_effect = {
	$ACTOR$ = {
		if = {
			limit = { $TARGET$.monthly_character_income > $THRESHOLD$ }
			$ACTOR$ = {
				save_temporary_scope_value_as = {
					name = temp_gold
					value = { value = $TARGET$.monthly_character_income multiply = $MONTHS$ }
				}
				pay_short_term_gold = {
					target = $TARGET$
					gold = scope:temp_gold
				}
				
			}
		}
		else = {
			$ACTOR$ = {
				save_temporary_scope_value_as = {
					name = temp_gold
					value = { value = $THRESHOLD$ multiply = $MONTHS$ }
				}
				pay_short_term_gold = {
					target = $TARGET$
					gold = scope:temp_gold
				}
			}
		}
	}
}



######################################
#Base Types
tributary_non_permanent = {
	define_tributary = {
		TRIBUTARY = $TRIBUTARY$
		SUZERAIN = $SUZERAIN$
		TRIBUTARY_BASE_TYPE = flag:non_permanent
	}
}

tributary_permanent = {
	define_tributary = {
		TRIBUTARY = $TRIBUTARY$
		SUZERAIN = $SUZERAIN$
		TRIBUTARY_BASE_TYPE = flag:permanent
	}
}

#Types
#flag:civilized  #上国教化
#flag:league 	 #互市同盟
#flag:hegemony   #霸主仆从

#tributary_civilized = {
#	define_tributary = {
#		TRIBUTARY = $TRIBUTARY$
#		SUZERAIN = $SUZERAIN$
#		TYPE = flag:civilized_tributary
#	}
#}
#
#tributary_league = {
#	define_tributary = {
#		TRIBUTARY = $TRIBUTARY$
#		SUZERAIN = $SUZERAIN$
#		TYPE = flag:civilized_tributary
#	}
#}
#
#tributary_hegemony = {
#	define_tributary = {
#		TRIBUTARY = $TRIBUTARY$
#		SUZERAIN = $SUZERAIN$
#		TYPE = flag:civilized_tributary
#	}
#}


#scope:first.culture = {
#	change_cultural_acceptance = {
#		target = scope:second.culture
#		value = miniscule_cultural_acceptance_gain
#		desc = pilgrimage_cultural_spread
#	}
#}


TributeSystem_tribute_relation_validity_check_effect = {
	if = {
		limit = {
			NAND = {
				$SUZERAIN$ = { TributeSystem_can_be_suzerain_of_trigger = { TRIBUTARY = $TRIBUTARY$ } }
				$TRIBUTARY$ = { TributeSystem_can_be_tributary_of_trigger = { SUZERAIN = $SUZERAIN$ } }
			}
		}

		$SUZERAIN$ = {
			if = {
                limit = {
                    is_target_in_variable_list = { name = non_permanent_tributaries target = $TRIBUTARY$ }
                }
                remove_list_variable = { name = non_permanent_tributaries target = $TRIBUTARY$ }
            }
            if = {
                limit = {
                    is_target_in_variable_list = { name = permanent_tributaries target = $TRIBUTARY$ }
                }
                remove_list_variable = { name = permanent_tributaries target = $TRIBUTARY$ }
            }
            remove_list_variable = { name = all_tributaries target = $TRIBUTARY$ }
			remove_trait = suzerain
			send_interface_message = {
				type = event_diplomacy_bad_with_text
				left_icon = $SUZERAIN$
				right_icon = $TRIBUTARY$
				title = TributeSystem_relation_validity_check_01_desc.tt
				desc = TributeSystem_relation_validity_check_01_desc
			}
		}
		$TRIBUTARY$ = {
			remove_relation_suzerain = $SUZERAIN$
			remove_variable = tributary_type
			remove_variable = my_suzerain
			remove_trait = tributary
			send_interface_message = {
				type = event_diplomacy_bad_with_text
				left_icon = $SUZERAIN$
				right_icon = $TRIBUTARY$
				title = TributeSystem_relation_validity_check_02_desc.tt
				desc = TributeSystem_relation_validity_check_02_desc
			}
		}
	}
}


#更换礼服
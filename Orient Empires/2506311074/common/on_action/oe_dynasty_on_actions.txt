on_game_start = {
	on_actions = {
		oe_dynasty_on_action
	}
}

oe_dynasty_on_action = {
	trigger = {
		is_house_head = yes
	}
	effect = {
		#前朝国号判定
		root = {
			if = {
				limit = {
					dynasty = dynasty:1000050303
				}
				house = {
					add_house_modifier = e_han
				}
			}
			if = {
				limit = {
					dynasty = dynasty:sishui_cao_dyn
				}
				house = {
					add_house_modifier = k_wei
				}
			}
			if = {
				limit = {
					dynasty = dynasty:henei_sima_dyn
				}
				house = {
					add_house_modifier = k_jin
				}
			}
			if = {
				limit = {
					dynasty = dynasty:1000050305
				}
				house = {
					add_house_modifier = e_song
				}
			}
			if = {
				limit = {
					house = house:house_nanliang_xiao 
				}
				house = {
					add_house_modifier = e_liang
				}
			}
			if = {
				limit = {
					AND = {
						dynasty = dynasty:lanling_xiao_dyn
						NOT = { house = house:house_nanliang_xiao }
					}
				}
				house = {
					add_house_modifier = k_qi
				}
			}
			if = {
				limit = {
					dynasty = dynasty:yingchuan_chen_dyn
				}
				house = {
					add_house_modifier = e_chen
				}
			}
			if = {
				limit = {
					dynasty = dynasty:hongnong_yang_dyn
				}
				house = {
					add_house_modifier = e_sui
				}
			}
			if = {
				limit = {
					dynasty = dynasty:longxi_li_dyn
				}
				house = {
					add_house_modifier = e_tang
				}
			}
			if = {
				limit = {
					dynasty = dynasty:1000048157
					current_date > 907.6.1
				}
				house = {
					add_house_modifier = e_liang
				}
			}
			if = {
				limit = {
				OR = {
					dynasty = dynasty:1000049851
					dynasty = dynasty:1000049852
				}
				current_date > 926.1.1
				}
				house = {
					add_house_modifier = e_tang
				}
			}
			if = {
				limit = {
					dynasty = dynasty:1000049854
				current_date > 937.1.1
				}
				house = {
					add_house_modifier = k_jin
				}
			}
			if = {
				limit = {
					dynasty = dynasty:1000049855
					current_date > 940.1.1
				}
				house = {
					add_house_modifier = e_han
				}
			}
			if = {
				limit = {
					OR = {
						dynasty = dynasty:1000048290
						dynasty = dynasty:1000048291
						dynasty = dynasty:taiyuan_wu_dyn
					}
					current_date > 952.1.1
				}
				house = {
					add_house_modifier = k_zhou
				}
			}
			if = {
				limit = {
					dynasty = dynasty:zhuojun_zhao_dyn
					current_date > 960.2.1
				}
				house = {
					add_house_modifier = e_song
				}
			}
		}

		#宗族威望等级
		root = {
			if = {
				limit = {
					culture = { has_cultural_pillar = heritage_chinese }
					any_close_or_extended_family_member = {
						is_male = yes
						is_adult = yes
						is_alive = no
						count > 200
					}
				}
				dynasty = {
					add_dynasty_prestige_level = {
						value = 5 max = 6
					}
			 	}
			}
			else_if = {
				limit = {
					culture = { has_cultural_pillar = heritage_chinese }
					any_close_or_extended_family_member = {
						is_male = yes
						is_adult = yes
						is_alive = no
						count > 80
					}
				}
				dynasty = {
					add_dynasty_prestige_level = {
						value = 4 max = 5
					}
			 	}
			}
			else_if = {
				limit = {
					culture = { has_cultural_pillar = heritage_chinese }
					any_close_or_extended_family_member = {
						is_male = yes
						is_adult = yes
						is_alive = no
						count > 30
					}
				}
				dynasty = {
					add_dynasty_prestige_level = {
						value = 3 max = 4
					}
				}
			}
			else_if = {
				limit = {
					OR = {
						culture = { has_cultural_pillar = heritage_chinese }
						culture = { has_cultural_pillar = heritage_yamato }
					}
					any_close_or_extended_family_member = {
						is_male = yes
						is_adult = yes
						is_alive = no
						count > 10
					}
				}
				dynasty = {
					add_dynasty_prestige_level = {
						value = 2 max = 3
					}
				}
			}
			else_if = {
				limit = {
					culture = { has_cultural_pillar = heritage_chinese }
					any_close_or_extended_family_member = {
						is_male = yes
						is_adult = yes
						is_alive = no
						count >= 2
					}
				}
				dynasty = {
					add_dynasty_prestige_level = {
						value = 1 max = 2
					}
				}
			}
			else_if = {
				limit = {
					OR = {
						culture = { has_cultural_pillar = heritage_chinese }
						culture = { has_name_list = name_list_khitan }
						culture = { has_name_list = name_list_yughur }
						culture = { has_name_list = name_list_uyghur }
						AND = {
							culture = { has_name_list = name_list_sogdian }
							exists = capital_province
							capital_province = { geographical_region = world_asia_china }
						}
					}
					OR = {
						any_close_family_member = {
							is_adult = yes
							count > 1
						}
						highest_held_title_tier > tier_county
					}
				}
				dynasty = {
					add_dynasty_prestige_level = {
						value = 2 max = 2
					}
				}
			}
		}
	}
}


#大家族延续
# Called from code once every five years for all characters.
# Root is the character
#five_year_everyone_pulse = {
#	on_actions = {
#		great_dynasty_marriage
#	}
#}

great_dynasty_marriage = {
	effect = {
		root = {
			if = { # Non-lowborn Barons should marry and produce a family
				limit = {
					exists = dynasty
					culture = { has_cultural_pillar = heritage_chinese }
					dynasty = { dynasty_prestige_level >= 3 }	
					is_adult = yes
					is_married = no
					can_marry_trigger = yes
					patrilinear_betrothal = no
					matrilinear_betrothal = no
					is_concubine = no
					is_ai = yes
					is_ruler = no
					NAND = {
						exists = matchmaker
						matchmaker = {
							OR = {
								is_ai = no
								this = liege
								highest_held_title_tier >= tier_county
							}
						}
					}
				}
				
				if = {
					limit = {
						exists = root.location
						any_pool_character = {
							location.kingdom = root.location.kingdom
							can_have_children_with = { CHARACTER = root }
							is_physically_able_adult = yes
							age <= 40
							is_married = no
							can_marry_trigger = yes
							is_concubine = no
							culture = root.culture
						}
					}
					random_pool_character = {
						#province = location.kingdom.capital_province
						limit = {
							location.kingdom = root.location.kingdom
							can_have_children_with = { CHARACTER = root }
							is_physically_able_adult = yes
							age <= 40
							is_married = no
							can_marry_trigger = yes
							is_concubine = no
							culture = root.culture
						}
						save_temporary_scope_as = spouse
					}
				}
				else = {
					create_character = {
						location = root.location
						culture = root.culture
						template = pool_repopulate_spouse
						save_temporary_scope_as = spouse
					}
				}

				if = {
					limit = {
						is_female = yes
						scope:spouse = {
							is_lowborn = yes
						}
					}
					marry_matrilineal = scope:spouse
				}
				else = {
					marry = scope:spouse
				}
			}
		}
	}
}